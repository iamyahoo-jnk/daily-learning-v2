<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .status {
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 4px;
            margin-left: 10px;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .pending { background: #fff3cd; color: #856404; }
        input, button {
            padding: 8px 12px;
            margin: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        #console {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸</h1>
    <p>í•µì‹¬ ì‹œìŠ¤í…œë“¤ì´ ì •ìƒ ì‘ë™í•˜ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.</p>

    <!-- Firebase ì—°ê²° í…ŒìŠ¤íŠ¸ -->
    <div class="test-section">
        <h2>1. Firebase ì—°ê²° í…ŒìŠ¤íŠ¸</h2>
        <p>Firebase ì´ˆê¸°í™” ë° ì—°ê²° ìƒíƒœ</p>
        <div>
            ìƒíƒœ: <span id="firebaseStatus" class="status pending">í…ŒìŠ¤íŠ¸ ì¤‘...</span>
        </div>
    </div>

    <!-- ì¸ì¦ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸ -->
    <div class="test-section">
        <h2>2. ì¸ì¦ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸</h2>
        <p>ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ ë° ì‚¬ìš©ì ì—­í•  í™•ì¸</p>
        
        <div>
            <h3>ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸</h3>
            <input type="text" id="testEmail" placeholder="ì´ë©”ì¼ ë˜ëŠ” ì•„ì´ë””" value="test123">
            <input type="password" id="testPassword" placeholder="ë¹„ë°€ë²ˆí˜¸" value="password123">
            <button onclick="testLogin()">ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸</button>
            <button onclick="testLogout()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
        
        <div style="margin-top: 10px;">
            ì¸ì¦ ìƒíƒœ: <span id="authStatus" class="status pending">í™•ì¸ ì¤‘...</span>
        </div>
        
        <div style="margin-top: 10px;">
            ì‚¬ìš©ì ì •ë³´: <span id="userInfo">-</span>
        </div>
    </div>

    <!-- ë°ì´í„°ë² ì´ìŠ¤ í…ŒìŠ¤íŠ¸ -->
    <div class="test-section">
        <h2>3. ë°ì´í„°ë² ì´ìŠ¤ í…ŒìŠ¤íŠ¸</h2>
        <p>Firestore ì½ê¸°/ì“°ê¸° ì‘ì—…</p>
        
        <div>
            <button onclick="testDatabase()">DB ì—°ê²° í…ŒìŠ¤íŠ¸</button>
            <button onclick="testRoster()">ë¡œìŠ¤í„° ì¡°íšŒ í…ŒìŠ¤íŠ¸</button>
        </div>
        
        <div style="margin-top: 10px;">
            ë°ì´í„°ë² ì´ìŠ¤ ìƒíƒœ: <span id="dbStatus" class="status pending">ëŒ€ê¸° ì¤‘...</span>
        </div>
    </div>

    <!-- ëª¨ë“ˆ ì„¤ì • í…ŒìŠ¤íŠ¸ -->
    <div class="test-section">
        <h2>4. ì•± ì„¤ì • í…ŒìŠ¤íŠ¸</h2>
        <p>ëª¨ë“ˆ ì„¤ì • ë° ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜</p>
        
        <div>
            <button onclick="testAppConfig()">ì„¤ì • ë¡œë“œ í…ŒìŠ¤íŠ¸</button>
        </div>
        
        <div style="margin-top: 10px;">
            ì„¤ì • ìƒíƒœ: <span id="configStatus" class="status pending">ëŒ€ê¸° ì¤‘...</span>
        </div>
        
        <div style="margin-top: 10px;">
            í™œì„±í™”ëœ ëª¨ë“ˆ: <span id="modulesList">-</span>
        </div>
    </div>

    <!-- ì „ì²´ í…ŒìŠ¤íŠ¸ -->
    <div class="test-section">
        <h2>5. ì „ì²´ í†µí•© í…ŒìŠ¤íŠ¸</h2>
        <button onclick="runAllTests()">ëª¨ë“  í…ŒìŠ¤íŠ¸ ì‹¤í–‰</button>
        <div style="margin-top: 10px;">
            ì „ì²´ ìƒíƒœ: <span id="overallStatus" class="status pending">ëŒ€ê¸° ì¤‘...</span>
        </div>
    </div>

    <!-- ì½˜ì†” ì¶œë ¥ -->
    <div class="test-section">
        <h2>ğŸ“‹ ì‹¤í–‰ ë¡œê·¸</h2>
        <div id="console">í…ŒìŠ¤íŠ¸ ëŒ€ê¸° ì¤‘...\n</div>
        <button onclick="clearConsole()">ë¡œê·¸ ì§€ìš°ê¸°</button>
    </div>

    <script type="module">
        // ì „ì—­ í•¨ìˆ˜ë“¤ì„ ìœ„í•œ import
        import { authManager } from './core/auth.js';
        import { dbManager } from './core/database.js';
        import { APP_CONFIG, utils } from './config/app-config.js';

        // ì½˜ì†” ë¡œê·¸ í•¨ìˆ˜
        function log(message, type = 'info') {
            const console = document.getElementById('console');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : 'â„¹ï¸';
            console.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            console.scrollTop = console.scrollHeight;
            
            // ë¸Œë¼ìš°ì € ì½˜ì†”ì—ë„ ì¶œë ¥
            console.log(`[TEST] ${message}`);
        }

        function setStatus(elementId, status, message) {
            const element = document.getElementById(elementId);
            element.className = `status ${status}`;
            element.textContent = message;
        }

        // 1. Firebase ì—°ê²° í…ŒìŠ¤íŠ¸
        function testFirebase() {
            try {
                // Firebase ê°ì²´ë“¤ì´ ì •ìƒì ìœ¼ë¡œ importë˜ì—ˆëŠ”ì§€ í™•ì¸
                if (authManager && dbManager) {
                    setStatus('firebaseStatus', 'success', 'ì—°ê²°ë¨');
                    log('Firebase ì—°ê²° ì„±ê³µ', 'success');
                    return true;
                } else {
                    throw new Error('Firebase ê°ì²´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
                }
            } catch (error) {
                setStatus('firebaseStatus', 'error', 'ì—°ê²° ì‹¤íŒ¨');
                log(`Firebase ì—°ê²° ì‹¤íŒ¨: ${error.message}`, 'error');
                return false;
            }
        }

        // 2. ì¸ì¦ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸
        window.testLogin = async function() {
            const email = document.getElementById('testEmail').value;
            const password = document.getElementById('testPassword').value;
            
            log(`ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸ ì‹œì‘: ${email}`);
            
            try {
                const result = await authManager.login(email, password);
                
                if (result.success) {
                    log(`ë¡œê·¸ì¸ ì„±ê³µ: ${result.user.email}`, 'success');
                    if (result.isNewUser) {
                        log('ì‹ ê·œ ì‚¬ìš©ìë¡œ ìë™ ê°€ì…ë¨', 'success');
                    }
                } else {
                    log(`ë¡œê·¸ì¸ ì‹¤íŒ¨: ${result.error}`, 'error');
                }
            } catch (error) {
                log(`ë¡œê·¸ì¸ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        };

        window.testLogout = async function() {
            log('ë¡œê·¸ì•„ì›ƒ í…ŒìŠ¤íŠ¸ ì‹œì‘');
            try {
                await authManager.logout();
                log('ë¡œê·¸ì•„ì›ƒ ì„±ê³µ', 'success');
            } catch (error) {
                log(`ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        };

        // 3. ë°ì´í„°ë² ì´ìŠ¤ í…ŒìŠ¤íŠ¸
        window.testDatabase = async function() {
            log('ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹œì‘');
            
            try {
                // í˜„ì¬ ë‚ ì§œë¡œ ë”ë¯¸ ë°ì´í„° í…ŒìŠ¤íŠ¸
                const todayKey = utils.getTodayKey();
                log(`ì˜¤ëŠ˜ ë‚ ì§œ í‚¤: ${todayKey}`);
                
                setStatus('dbStatus', 'success', 'ì—°ê²°ë¨');
                log('ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì„±ê³µ', 'success');
            } catch (error) {
                setStatus('dbStatus', 'error', 'ì—°ê²° ì‹¤íŒ¨');
                log(`ë°ì´í„°ë² ì´ìŠ¤ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        };

        window.testRoster = async function() {
            log('ë¡œìŠ¤í„° ì¡°íšŒ í…ŒìŠ¤íŠ¸ ì‹œì‘');
            
            try {
                const result = await dbManager.getRoster();
                
                if (result.success) {
                    log(`ë¡œìŠ¤í„° ì¡°íšŒ ì„±ê³µ: ${result.data.length}ëª…`, 'success');
                    result.data.forEach(student => {
                        log(`- ${student.displayName || student.email || student.uid}`);
                    });
                } else {
                    log(`ë¡œìŠ¤í„° ì¡°íšŒ ì‹¤íŒ¨: ${result.error || result.message}`, 'error');
                }
            } catch (error) {
                log(`ë¡œìŠ¤í„° ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        };

        // 4. ì•± ì„¤ì • í…ŒìŠ¤íŠ¸
        window.testAppConfig = function() {
            log('ì•± ì„¤ì • í…ŒìŠ¤íŠ¸ ì‹œì‘');
            
            try {
                const enabledModules = utils.getEnabledModules();
                const todayKey = utils.getTodayKey();
                
                log(`í™œì„±í™”ëœ ëª¨ë“ˆ ìˆ˜: ${enabledModules.length}`);
                enabledModules.forEach(module => {
                    log(`- ${module.name} (${module.id})`);
                });
                
                log(`ì˜¤ëŠ˜ ë‚ ì§œ: ${todayKey}`);
                log('í•™ìƒ ê³„ì • í…ŒìŠ¤íŠ¸: ' + utils.isStudentAccount('test@id.local'));
                log('êµì‚¬ ê³„ì • í…ŒìŠ¤íŠ¸: ' + utils.isTeacherAccount('teacher@gmail.com'));
                
                setStatus('configStatus', 'success', 'ë¡œë“œë¨');
                document.getElementById('modulesList').textContent = 
                    enabledModules.map(m => m.name).join(', ');
                
                log('ì•± ì„¤ì • í…ŒìŠ¤íŠ¸ ì„±ê³µ', 'success');
            } catch (error) {
                setStatus('configStatus', 'error', 'ë¡œë“œ ì‹¤íŒ¨');
                log(`ì•± ì„¤ì • ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        };

        // 5. ì „ì²´ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        window.runAllTests = async function() {
            log('=== ì „ì²´ í…ŒìŠ¤íŠ¸ ì‹œì‘ ===', 'success');
            
            let passedTests = 0;
            let totalTests = 4;
            
            // 1. Firebase í…ŒìŠ¤íŠ¸
            if (testFirebase()) passedTests++;
            
            // 2. ì•± ì„¤ì • í…ŒìŠ¤íŠ¸
            try {
                testAppConfig();
                passedTests++;
            } catch (error) {
                log(`ì„¤ì • í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
            
            // 3. ë°ì´í„°ë² ì´ìŠ¤ í…ŒìŠ¤íŠ¸
            try {
                await testDatabase();
                passedTests++;
            } catch (error) {
                log(`DB í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
            
            // 4. ì¸ì¦ í…ŒìŠ¤íŠ¸ (ìë™ ë¡œê·¸ì¸)
            try {
                await testLogin();
                passedTests++;
            } catch (error) {
                log(`ì¸ì¦ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
            
            // ê²°ê³¼ ì •ë¦¬
            const success = passedTests === totalTests;
            const message = `${passedTests}/${totalTests} í…ŒìŠ¤íŠ¸ í†µê³¼`;
            
            setStatus('overallStatus', success ? 'success' : 'error', message);
            log(`=== ì „ì²´ í…ŒìŠ¤íŠ¸ ì™„ë£Œ: ${message} ===`, success ? 'success' : 'error');
        };

        window.clearConsole = function() {
            document.getElementById('console').textContent = '';
        };

        // ì¸ì¦ ìƒíƒœ ë³€ê²½ ê°ì§€
        authManager.addAuthListener((user) => {
            if (user) {
                const role = authManager.getUserRole(user);
                setStatus('authStatus', 'success', 'ë¡œê·¸ì¸ë¨');
                document.getElementById('userInfo').textContent = 
                    `${user.email} (${role})`;
                log(`ì‚¬ìš©ì ë¡œê·¸ì¸: ${user.email} - ì—­í• : ${role}`, 'success');
            } else {
                setStatus('authStatus', 'pending', 'ë¡œê·¸ì•„ì›ƒë¨');
                document.getElementById('userInfo').textContent = '-';
                log('ì‚¬ìš©ì ë¡œê·¸ì•„ì›ƒ');
            }
        });

        // í˜ì´ì§€ ë¡œë“œ ì‹œ Firebase í…ŒìŠ¤íŠ¸
        document.addEventListener('DOMContentLoaded', () => {
            log('í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ - ê¸°ë³¸ í…ŒìŠ¤íŠ¸ ì‹¤í–‰');
            testFirebase();
        });
    </script>
</body>
</html>